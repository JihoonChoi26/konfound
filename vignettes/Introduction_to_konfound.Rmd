---
title: "Introduction to konfound"
author: "Joshua Rosenberg, Ran Xu, and Ken Frank"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{forcats}
  ---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 5, fig.width = 5, cache = FALSE)
```

# Abstract

*This abstract is adapted from Xu, Frank, and Maroulis' STATA tutorial "What would it take to Change your Inference? Quantifying the Discourse about Causal Inferences in the Social Sciences."*

Statistical methods that quantify the discourse about causal inferences in terms of possible sources of biases, or “sensitivity analysis,” are becoming more important to a variety of social science fields, including research in education, public policy, and political science.  A series of recent works by Frank and colleagues on sensitivity analysis points to limitations in earlier methods and aims to extend beyond them. We implement these developments, which previously have been implemented in `Stata`, in `R` through the `konfound` package. In particular, we provide functions for quantifying the bias necessary to alter an inference, from the framework of Rubin's (1974) causal model, as well as the robustness of causal inference in terms of the impact threshold of a confounding variable.

# Introduction

# Examples

`konfound` is an `R` package to easily carry out sensitivity analysis as described in Frank, Maroulis, Duong, and Kelcey (2013) based on Rubin's (1974) causal model.

### Installation

You can install konfound from GitHub (it will be available on CRAN and therefore via `install.packages("konfound")` soon) with:

```{r gh-installation, eval = FALSE}
install.packages("devtools")
devtools::install_github("jrosen48/konfound")
```

### Loading konfound

```{r, eval = F}
library(konfound)
```

```{r, echo = F}
devtools::load_all(".")
```

### Use of pkonfound()

`pkonfound()` is used when we have values from an already-conducted analysis, such as one in an already-published study or from an analysis carried out using other software.

For example, in the use below, we simply enter the values for the unstandardardized beta coefficient (`2`), its standard error (`.4`), the sample size (`100`), and the number of covariates (`3`)

```{r}
pkonfound(.4, 2, 100, 3)
```

Here is another example, but one in which the unstandardized beta coefficient is smaller than its standard error:

```{r}
pkonfound(.4, 2, 100, 3)
```

We can also choose from a number of forms of output to return, such as a plot of the output from the correlation-based approach:

```{r, fig.height = 7, fig.width = 7}
pkonfound(2, .4, 100, 3, to_return = "corr_plot")
```

And the threshold plot associated with the replacement of cases approach:

```{r}
pkonfound(.4, 2, 100, 3, to_return = "thresh_plot")
```

Finally, you can return the raw output, for use in other analyses. 

```{r}
pkonfound(.4, 2, 100, 3, to_return = "raw_output")
```

You can also specify multiple forms of output at once. 

```{r}
model_output <- pkonfound(2, .4, 200, 3, to_return = c("raw_output", "thresh_plot", "corr_plot"))
summary(model_output)
```

When we type the name of the object, we see that we created three types of output that we can access as follows:

```{r}
model_output$raw_output
model_output$thresh_plot
model_output$corr_plot
```

### Use of konfound()

##### For linear models fit with lm()

```{r}
m1 <- lm(mpg ~ wt + hp + qsec, data = mtcars)
m1

konfound(m1, hp)
konfound(m1, test_all = T)
```

You can also return a table with some key output from the correlation-based approach.

```{r}
konfound(m1, wt, to_return = "table")
```

If the impact threshhold is greater than the impacts of the `Z`s (the other covariates) then an omitted variable would have to have a greater impact than any of the observed covariates to change the inference. 

Note that in fields in which there is a lot known about covariates given the outcome of interest, then the omitted ones are likely less important than those that are known an included (i.e., for educational achievement, we have a good sense of the factors that matter).

##### For generalized linear models fit with glm()

Effects for these models are interpreted on the basis of average partial (or marginal) effects (calculated using the `margins` package).

```{r, message = F}
# if forcats is not installed, this install it first using install.packages("forcats") for this to run
if (requireNamespace("forcats")) {
    d <- forcats::gss_cat
    
    d$married <- ifelse(d$marital == "Married", 1, 0)
    
    m2 <- glm(married ~ age, data = d, family = binomial(link = "logit"))
    konfound(m2, age)
}
```

### Use of mkonfound()

Here, `d` represents output from a number (30 in this case) of past studies, read in a CSV file from a website:

```{r, warning = F}
d <- read.csv("https://msu.edu/~kenfrank/example%20dataset%20for%20mkonfound.csv")
mkonfound(d, t, df)
mkonfound(d, t, df, return_plot = T)
```

We can also use the same input as `pkonfound()`, using `mkonfound_d()
```{r}
library(dplyr)

d <- data.frame(unstd_beta = c(2, 10, 1.7, .4, 3.2, 1.0, 2.3, 4.1, .9),
                std_error = c(.3, 2.9, 1.5, 2, .1, .04, .1, 3, .5),
                n_obs = c(70, 405, 200, 100, 103, 20, 50, 721, 320),
                n_covs = c(3, 4, 1, 3, 10, 4, 1, 1, 0))

mkonfound_d(d)
```

# References

* Frank, K.A., Maroulis, S., Duong, M., and Kelcey, B. 2013. What would it take to Change an Inference?: Using Rubin’s Causal Model to Interpret the Robustness of Causal Inferences. Education, Evaluation and Policy Analysis.  Vol 35: 437-460. https://msu.edu/~kenfrank/What%20would%20it%20take%20to%20Change%20an%20Inference%20published.docx

* Frank, K.A., Gary Sykes, Dorothea Anagnostopoulos, Marisa Cannata, Linda Chard, Ann Krause, Raven McCrory. 2008. Extended Influence: National Board Certified Teachers as Help Providers. Education, Evaluation, and Policy Analysis. Vol 30(1): 3-30. https://msu.edu/~kenfrank/papers/Does%20NBPTS%20Certification%20Affect%20the%20Number%20of%20Colleagues%20a%20Teacher%20Helps%20with%20Instructional%20Matters%20acceptance%20version%202.doc

* Frank, K. A. and Min, K. 2007. Indices of Robustness for Sample Representation. Sociological Methodology. Vol 37, 349-392. https://msu.edu/~kenfrank/papers/INDICES%20OF%20ROBUSTNESS%20TO%20CONCERNS%20REGARDING%20THE%20REPRESENTATIVENESS%20OF%20A%20SAMPLE.doc (co first authors)

* Frank, K. 2000. "Impact of a Confounding Variable on the Inference of a Regression Coefficient." Sociological Methods and Research, 29(2), 147-194 https://msu.edu/~kenfrank/papers/impact%20of%20a%20confounding%20variable.pdf